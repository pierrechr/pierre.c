%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Header and packages 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[10pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsfonts,amssymb,amsmath,amsthm}
\usepackage[a4paper, top=15pt, marginparwidth=25pt, textwidth=510pt, textheight=550pt, bottom=50pt]{geometry}
\usepackage[pdftex]{color,graphicx}
\usepackage{marginnote}


\reversemarginpar
\newtheorem{thm}{Theorem}
\theoremstyle{definition}
\newtheorem{definition}{Definition}
\newtheorem{proposition}{Proposition}
\newtheorem{remark}{Remark}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Symbols
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\N}{\mathbb{N}}
\newcommand{\F}{\mathbb{F}}
\renewcommand{\L}{\mathbb{L}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\D}{\mathbb{D}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\K}{\mathbb{K}}
\renewcommand{\P}{\mathbb{P}}
\newcommand{\Pp}{$\mathcal{P}$}
\newcommand{\ch}{\textrm{ch}}
\newcommand{\sh}{\textrm{sh}}
\newcommand{\id}{\textrm{Id}}
\newcommand{\atan}{\textrm{Arctan}}
\newcommand{\acos}{\textrm{Arccos}}
\newcommand{\asin}{\textrm{Arcsin}}
\newcommand{\Mat}{\textrm{Mat}}
\newcommand{\Gl}{\textup{Gl}}
\newcommand{\Ker}{\textup{Ker}}
\newcommand{\E}{\textrm{E}}
\newcommand{\card}{\textup{card}}
\newcommand{\rg}{\textup{rg}}
\renewcommand{\Im}{\textup{Im}}
\renewcommand{\Gl}{\textrm{Gl}}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\author{Pierre Chr√©tien}
\title{Practical Invalid Curve Attack Using Quadratic Twist}
\date{February 2025}
\maketitle
\begin{abstract}
We present the common structure of the attack and give some insight to efficiently exploit quadratic twists. 
This paper has primarily an expository role.
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Body
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}

The so called \textsl{Invalid curve attack} is a real threat for cryptographic protocols based on elliptic curves.
The attack has first been presented in \cite{BMM00} and the use of twists was described in\cite{FLRV08}.
OpenPGP.js prior to 4.2.0 was found to be vulnerable\footnote{https://www.cve.org/CVERecord?id=CVE-2019-9155}. 
Bluetooth was proved to be vulnerable to a "Fixed Coordinate" variant  \cite{cryptoeprint:2019/1043}.
Edwards model has also been examined in \cite{NT15}.
The SafeCurves website and the associated paper \cite{cryptoeprint:2024/1265} point out as 
\begin{quote}
An ECC implementor can stop an invalid-curve attack by checking whether the input point Q satisfies the correct curve equation; [...]
But this creates a conflict between simplicity and security. An implementation that does not include this check is simpler and more likely to be produced, and will pass typical functionality tests. 
\end{quote}

\noindent As a side note, it is also at heart of many Capture The Flag and cryptographic challenges on dedicated platforms.

\vspace*{.5cm}
\noindent The rest of the paper is organized as follows.
Section 2 recalls the basics mathematical concepts used  in the sequel, we recall basics facts about discrete logarithm problem (DLP) and twists of elliptic curves.	
Section 3 presents the general setting of the attack and ways to exploit poor implementation and weak curves.
Section 4 is a complete walktrhought an example.
This paper has primarily an expository role.

\section{Background Material}

\textbf{Notations :}
We will denote by $\F_q$ the finite field with $q = p^n$ elements where $p \geq 5$ and $n \in \N - \lbrace 0 \rbrace$.
We will denote by $E/\F_q$ an elliptic curve defined over $\F_q$. 
The reader is assumed to be familiar with basic theory of elliptic curves.

\vspace*{.5cm}

\noindent \textbf{Short Weierstrass equations.} The characteristic $p$ being different from $2$ and $3$, every elliptic curve $E/\F_q$ may be written as
\[ E : y^2 = x^3 + ax + b, \; \; a,b \in \F_q. \]
This is a so called \textsl{short Weierstrass form} of the curve $E$ \textsl{defined over $\F_q$}.

\vspace*{.5cm}

\noindent \begin{remark} 
\begin{enumerate}
\item The characteristic $p$ being greater than $5$ is not a restriction in our context since $p$ will usually be a large prime.
\item A short Weierstrass form is not unique.
This will be completed in the subsection about twists.

\begin{verbatim}
k = GF(11**2)
u = k(2)
E = EllipticCurve(k,[1,1])
E_ = EllipticCurve(k,[u**(-4),u**(-6)])
E.is_isomorphic(E_)
E.isomorphism_to(E_)
\end{verbatim}
\end{enumerate}
\end{remark}

\noindent \textbf{Automorphisms.} Let $E_1/\F_q$ and $E_2/\F_q$ be elliptic curves. 
These curves may be seen over $\overline{\F_q}$ that is, the coefficients of their equation may be seen as lying in $\overline{\F_q}$ instead of in $\F_q$.
Every geometric isomorphism of elliptic curve $\phi$ from $E_1/\overline{\F_q}$ to $E_2/\overline{\F_q}$ has an  affine part of the form 
\begin{equation}\label{morphism}
 \phi(x,y) = (u^{\mkern1mu 2}x + r, u^{\mkern1mu 3}y + su^{\mkern1mu 2}x + t).
\end{equation}
for $u \in \overline{\F_q}^{\mkern1mu *}$, $r,s,t \in \overline{\F_q}$.
We will denote geometric isomorphism as $\phi/\overline{\F_q}$.
The isomorphism $\psi$ is said to be \textsl{defined over $\F_q$} or \textsl{rational} if $u,r,s,t \in \F_q$, we will denote it by $\psi/\F_q$.

For a sake of clarity we will stick to the notation $\phi$ for geometric isomorphism and $\psi$ for rational isomorphisms.

\begin{proposition}\label{prop:auto}
Let $E_i/\F_q$, $i \in \lbrace 1; 2 \rbrace$ be elliptic curves given by short Weierstrass equations.
\[ E_i : y^2 = x^3 + a_ix + b_i, \; \; a_i,b_i \in \F_q. \]
A geometric isomorphism $\phi$ has the form 
\[ \phi(x,y) = (u^{\mkern1mu 2}x, u^{\mkern1mu 3}y).\]  
\end{proposition}
\begin{proof}
This is included as a first step to fully understand isomorphisms in the quadratic twist case.

\noindent Let $(x,y) \in E_1$ and $\phi$ as given by (\ref{morphism}).
Applying $\phi$ to the equation of $E_1$ and expanding yields 
\begin{align*}
&y^2 = x^3 + a_1x + b_1\\
 & \Leftrightarrow ( u^{\mkern1mu 3}y + su^{\mkern1mu 2}x + t)^{\mkern1mu 2} =  (u^{\mkern1mu 2}x +r)^{\mkern1mu 3} +a_1(u^{\mkern1mu 2}x +r) +b_1 \\
& \Leftrightarrow  u^{\mkern1mu 6}y^2 + s^2u^{\mkern1mu 4}x^2 + t^2 + 2u^{\mkern1mu 5}sxy + 2u^{\mkern1mu 3}ty + 2tsu^{\mkern1mu 2}x  
=  u^{\mkern1mu 6}x^3 + 3ru^{\mkern1mu 4}x^2 + 3r^2 u^{\mkern1mu 2}x +r^{\mkern1mu 3} +a_1u^{\mkern1mu 2}x +a_1r +b_1 (*)\\
\end{align*} 
Identifying coefficients of $xy$ and $y$ with those of $y^2 = x^3 + a_2x + b_2$ yields $s=0, t= 0$ (recall that $u \neq 0$ and $ p \neq 2$).
\begin{align*}
(*) & \Leftrightarrow  u^{\mkern1mu 6}y^2   
=  u^{\mkern1mu 6}x^3 + 3ru^{\mkern1mu 4}x^2 + 3r^2 u^{\mkern1mu 2}x +r^{\mkern1mu 3} +a_1u^{\mkern1mu 2}x +a_1r +b_1 
\end{align*}
Then, identifying the coefficient of $x^2$ with the short equation of $E_2$ yields $r=0$ (here we use $p \neq 3$).
Thus $\phi(x,y) = (u^2x,u^3y)$.
We conclude with the following computations that will be used in the sequel.
\begin{align*}
 &u^{\mkern1mu 6}y^2   
=  u^{\mkern1mu 6}x^3 +a_1u^{\mkern1mu 2}x  +b_1 \\
& \Leftrightarrow  y^2   
=  x^3 +\frac{a_1}{u^{\mkern1mu 4}}x  + \frac{b_1}{u^6} \\
& \Leftrightarrow
\frac{a_1}{u^{\mkern1mu 4}} = a_2 , \; \;  \frac{b_1}{u^6}=b_2 (**)
\end{align*}
\end{proof}


\begin{proposition}
Let $E/\F_q$ be an elliptic curves given by short Weierstrass equations.
\[ E_i : y^2 = x^3 + ax + b, \; \; a, b \in \F_q. \]
The \textsl{$j$-invariant of E} is defined to be 
\[j(E) = 1728 \frac{4a^3}{4a^3+27b^2}.\]

Given two elliptic curves $E_1, E_2$ defined over $\F_q$, there exists a geometric isomorphism $\phi / \overline{\F_q}$ from $E_1$ to $E_2$ if and only if $j(E_1) = j(E_2)$. 
\end{proposition}

\noindent \begin{remark}
\begin{enumerate}
\item We insist that the $j$-invariant classifies \textbf{geometric} isomorphism classes of elliptic curves over $\F_q$. 
\item Thanks to $p \geq 5$, $E$ has a short equation and $j(E)$ a special form in this case.
Thus $j(E) \notin \lbrace 0, 1728 \rbrace \Leftrightarrow a,b \in \F_q^{*}$.
\end{enumerate}
\end{remark}

\subsection{Twists of Elliptic Curves}

\noindent \textbf{Twists.} Non trivial twists of $E/\F_q$ are elliptic curves $E'/\F_q$ being isomorphic to $E$ when viewed over $\overline{\F_q}$ but not isomorphic to $E$ when viewed over $\F_q$.

\begin{definition}
Le $E/\F_q$ be an elliptic curve.
A \textsl{twist of $E$} is an elliptic curve $E_t/\F_q$ such that there is a geometric isomorphism $\phi/\overline{\F_q}$ of elliptic curves $\phi : E \simeq E_t$.
A twist $E_t$ of $E$ is \textsl{trivial} if there exists an isomorphism $\psi$ of elliptic curve \textbf{defined over} $\F_q$.
\end{definition}

\vspace*{.5cm}
\noindent \textbf{Quadratic Twists.} Let $E/\F_q$ be an elliptic curve in short Weierstrass equation $y^2 = x^3+ax+b$.
Recall that $q = p^n$ and $p \geq 5$, so it is possible to write such an equation for $E$. 

\begin{definition}
Let $d \in \F_q^*$.
The \textsl{twist $E_d$ of $E$ by d} is the elliptic curve given in short Weierstrass equation
\[ E_d : y^2 = x^3 + d^{\mkern1mu 2}ax + d^{\mkern1mu 3}b.\]
\end{definition}

\begin{remark}
We did not specify that $E_d$ is a non trivial twist of $E$.
Proposition \ref{prop:trivialtwist} recalls when $E_d$ is trivial.
Actually, let $\delta$ be a square root of $d$ in $\overline{\F_q}$ i.e. $\delta^2 = d$, then
\begin{align*}
\phi : E & \to E_d\\
      (x,y)& \mapsto \big(\frac{x}{d},\frac{y}{d\delta}\big)
\end{align*}
is a geometric isomorphism from $E$ to $E_d$.
It matches the relations (**) concluding proof of Proposition \ref{prop:auto} with $a_1=a, b_1=b, a_2 = ad^2, b_2=bd^3$ and $d = \frac1u$.
\end{remark}

\begin{proposition}\label{prop:trivialtwist}
Assume that $j(E) \neq 0,1728$.
The twist $E_d$ is trivial if and only if $d \in (\F_q^*)^2$.
\end{proposition}

\begin{proof}
$(\Rightarrow)$ Assume that there exists a rational isomorphism $\psi$ from $E$ to $E_d$.
According to Proposition \ref{prop:auto}, there exists $u \in \F_q^*$
\[ \psi(x,y) = (u^2x,u^3y) \]

According to (**), $\frac{a}{u^4} = ad^2$ and $\frac{b}{u^6} = bd^3$.
Recall that since $ p \geq 5$, the assumption about $j(E)$ is equivalent to $a,b \neq 0$.
Thus $\frac{1}{u^4} = d^2$, $\frac{1}{u^6} = d^3$ and $d = \frac{d^3}{d^2} = \frac{1}{u^2} \in (\F_q^*)^2$.

$(\Leftarrow)$ Conversely, let $\delta \in \F_q^*$ such that $\delta^2 = d$.
Then 
\[ \psi(x,y) = \big(\frac{x}{d},\frac{y}{d\delta}\big) \]
is a rational isomorphism from $E$ to $E_d$.
\end{proof}


\begin{proposition}
Assume that $E/\F_q$ has $j(E) \neq 0, 1728$. 
Then a twist $E_t/\F_q$ of $E/\F_q$ is either trivial or $E_d$ for some $d \in (\F_q^*) \backslash (\F_q^*)^2$.
\end{proposition}
\begin{proof}
Assume that $E_t/\F_q$ is a non trivial twist of $E/\F_q$ with isomorphism $\phi : E \to E_t$ given by $\phi(x,y) = (u^2x,u^3y)$, $u \in \overline{\F_q}$, $u \notin \F_q$.
Let $E_t : y^2 = x^3 +a_tx+b_t$, $a_t,b_t \in \F_q$, thus (**) yields
\[ a_t = \frac{a}{u^4}, b_t = \frac{b}{u^6} \]
Then $u^2 = \frac{ba_t}{ab_t} \in \F_q$, i.e. $u \notin \F_q$ but $u^2 \in \F_q$.
This means that $u \in \F_{q^2} \backslash \F_q$.
Let $d := \frac{1}{u^2}$, then $a_t = d^2a, b_t = d^3b$ and $\phi(x,y) = \big(\frac{x}{d},\frac{uy}{d} \big)$.
\end{proof}


\noindent \begin{remark}
Proposition \ref{prop:trivialtwist} is wrong if $p < 5$.
For example, let $p=q=3$, $E : y^2 = x^3 + x + 1$ and $d = 2$.
In this case, $E$ is isomorphic to $E_d : y^2 = x^3+x+2$  with $\psi$ given by constants $(u,r,s,t) = (2,2,0,0)$.
So $E_d$ is a trivial twist of $E$ but $d$ is non square modulo $3$.
Note that the definition for the $j$-invariant when $p=3$ gives here $j(E) = 0$.
\end{remark}

\noindent \textbf{Order of group of rational points.} The group of rational points $E(\F_q)$ has order $\sharp E(\F_q) = q + 1 -t$ where $t$ is the \textsl{Trace of Frobenius}.
An extensive description of the Frobenius endomorphism is out scope for this paper, we only need some basics facts we recall below.

\begin{proposition}
\begin{enumerate}
\item \textbf{(Hasse Bound)} One has $|t|  \leq 2 \sqrt{q}$.
\item One has $\sharp E_d(\F_q) = q+1+t$.
\end{enumerate}
\end{proposition}

\begin{remark}
\begin{enumerate}
\item The previous Proposition implies that $|\sharp(E_d(\F_q)) - \sharp(E(F_q))| \leq 4\sqrt{q}$, so $\sharp(E_d(\F_q))$ and $\sharp(E(F_q))$ are in the same order of magnitude.
But even if $\sharp(E(\F_q)) = hp$ with $p$ prime and $h$ a small cofactor (a classical situation in cryptographic applications) then $\sharp(E_d(\F_q))$ might have a factorization many small primes (such numbers are called \textsl{smooth}).

For example \textbf{brainpoolP256t1} 

\begin{verbatim}
p	0xa9fb57dba1eea9bc3e660a909d838d726e3bf623d52620282013481d1f6e5377
a	0xa9fb57dba1eea9bc3e660a909d838d726e3bf623d52620282013481d1f6e5374
b	0x662c61c430d84ea4fe66a7733d0b76b7bf93ebc4af2f49256ae58101fee92b04
G	(0xa3e8eb3cc1cfe7b7732213b23a656149afa142c47aafbc2b79a191562e1305f4, 0x2d996c823439c56d7f7b22e14644417e69bcb6de39d027001dabe8f35b25c9be)
n	0xa9fb57dba1eea9bc3e660a909d838d718c397aa3b561a6f7901e0e82974856a7
h
0x1
Ecrire brain pool,
ses twists
trouver d
comparer avec l'iso donne par Sage
Calculer le j
\end{verbatim}

\end{enumerate}
\end{remark}

\vspace*{.5cm}
\begin{itemize}
\item dans la remarque sur j diff√©rent de 0,1728. Dire que a ou b = 0 est peut commun pour l'usage crypto (courbes anormales ou supersing)
\end{itemize}

\subsection{Discrete Logarithm Problem}

\begin{definition}
Let $G$ be a group in multiplicative notation.
The \textbf{Discrete Logarithm Problem} (DLP) is : given $b,h \in G$ find $a \in \Z$ such that $h = b^a$.
\end{definition}

\noindent \begin{remark}
\begin{enumerate}
\item The group law on an elliptic curve is usually written in additive notation.
So the DLP for elliptic curves order of may be rephrased : given $P,B \in E(\F_q)$ find $a \in \Z$ such that $P = aB$.
We will stick to this setting.
\item The DLP has a solution if and only if $P$ is in the subgroup \textless$B$\textgreater~generated by $B$.
\end{enumerate}
\end{remark}

%The DLP is a deep problem, we will even not give an overview but roughtly speaking there are two kinds of methods for solving DLP.
%One the one hand, general algorithms that do not make use of any particular structure of $G$.
%Such algorithms are Baby Step Giant Step, Pollard Rho, Lambda and Pseudorandom walks.
%They are based on collision findings.
%One the other hand, specific algorithms that make use of knowledge about $G$.
%Quadratic sieve, Number field sieve, Index Calculus, Coppersmith's method. 
%These lasts algorithms are way faster but need much more advanced mathematics and pre-computation.



The following discussion gives the necessaries notions when dealing with generic methods to solve the DLP that will be used in the last section.
The generic \verb|discrete_log| method from Sage uses a combination of Pohlig-Hellman, Baby step giant step, Pollard‚Äôs kangaroo (i.e. Pollard's Lambda), and Pollard‚Äôs Rho. 

\begin{itemize}
\item The Pohlig-Helmann method.
Let $n$ be the order of a point $B \in E/\F_q$ and assume that $n = \prod_{i = 1}^m p_i^{n_i}$ be its prime factorization.
The subgroup $H$ generated by $B$ is cyclic of order $n$, thus has a unique cyclic subgroup $H_i$ of order $p_i^{n_i}$ for each $i \in [| 1; m|]$.
By means of the Chinese Remainder Theorem, solving the DLP in $H$ boils down to solve it in each $H_i$. 
The subgroups $H_i$ have order a prime power, which may still be quite large. 
One can reduce the DLP from $H_i$ to subgroups of order \textbf{exactly} $p_i$.
\item BSGS method is a collision finding algorithm that requires $\mathcal{O}(\sqrt{p_i})$ running time and $\mathcal{O}(\sqrt{p_i})$ storage.
This gives an bound on the size of the $p_i$'s for which we can hope to solve the DLP with this method.
\item Pollard's Rho (resp. Lambda) algorithm has $\mathcal{O}(\sqrt{p_i})$ (resp. $\mathcal{O}(\sqrt{p_i})$) time complexity but $\mathcal{O}(1)$ ) (resp. $\mathcal{O}(\ln{p_i})$) space complexity.
\end{itemize}

\section{Invalid Curve Attack}
\subsection{General Setting}
Position du probl√®me : les algo de multiplication d*P n'utilisent que le coeff a de E, on peut passer (x,y) n'√©tant pas sur E.

\begin{itemize}
\item DLP peut etre trop dur sur E √† cause de d'un ordre pas assez smooth.
\item Si on peut faire calculer k*T pour T sur une autre courbe E' on peut trouver T modulo les premiers de l'ordre de E'.
\item si le twist a un ordre avec d'autres facteurs premier que E alors on connait k modulo de nouveaux premiers. 
\item cela peut suffire √† retrouver k (CRT)
\item Expliquer que connaitre d modulo "suffisament" de premiers peut suffire, pas modulo "tous" les premiers.
\end{itemize}

\subsection{Exploiting Ladders and twists}
\begin{itemize}
\item L'importance des ladders cf Safe Curves
\item L'importance des multiplications o√π on ne passe que le x.
\end{itemize}


\bibliographystyle{plain}
\bibliography{refs}

\end{document}
